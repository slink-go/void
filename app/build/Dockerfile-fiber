ARG GOLANG_VERSION
ARG UPX_VERSION
FROM mvkvl/golang_upx:${GOLANG_VERSION}-upx-${UPX_VERSION} AS build

COPY        /   /src
WORKDIR         /src/api-gateway/cmd/fiber
RUN CGO_ENABLED=0 GOOS=linux go get && go mod tidy
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o /fiber-proxy .
#RUN upx --best -o /fiber-proxy-packed  /fiber-proxy

FROM scratch

#FROM debian:10-slim
#RUN apt update && apt install iputils-ping -y

#COPY --from=build   /fiber-proxy-packed   /fiber-proxy
COPY --from=build   /fiber-proxy   /fiber-proxy

CMD ["/fiber-proxy"]
